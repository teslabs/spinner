<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Current sampling &mdash; Spinner  documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../_static/plot_directive.css" />
      <link rel="stylesheet" type="text/css" href="../_static/css/custom.css?v=86bd4ea3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/light.css?v=a0baf2e0" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../_static/doctools.js?v=888ff710"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Field Oriented Control" href="foc.html" />
    <link rel="prev" title="Spinner Documentation" href="../index.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html">
            
              <img src="../_static/logo.svg" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                1.0.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Theory</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Current sampling</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#shunt-resistors">Shunt resistors</a></li>
<li class="toctree-l2"><a class="reference internal" href="#sv-pwm">SV-PWM</a></li>
<li class="toctree-l2"><a class="reference internal" href="#sampling-strategy">Sampling strategy</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="foc.html">Field Oriented Control</a><ul>
<li class="toctree-l2"><a class="reference internal" href="foc.html#space-vector">Space Vector</a></li>
<li class="toctree-l2"><a class="reference internal" href="foc.html#clarke-transform">Clarke transform</a></li>
<li class="toctree-l2"><a class="reference internal" href="foc.html#park-transform">Park transform</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="svpwm.html">SV-PWM</a><ul>
<li class="toctree-l2"><a class="reference internal" href="svpwm.html#sector-determination">Sector determination</a></li>
<li class="toctree-l2"><a class="reference internal" href="svpwm.html#amplitude-limitation">Amplitude limitation</a></li>
<li class="toctree-l2"><a class="reference internal" href="svpwm.html#duty-cycles-calculation">Duty cycles calculation</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Components</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../components/cloop/index.html">Current Loop</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../components/cloop/index.html#api">API</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../components/currsmp/index.html">Current Sampling</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../components/currsmp/index.html#introduction">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../components/currsmp/index.html#api">API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../components/currsmp/index.html#implementations">Implementations</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../components/currsmp/impl/stm32.html">STM32</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../components/feedback/index.html">Feedback</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../components/feedback/index.html#introduction">Introduction</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../components/feedback/index.html#halls">Halls</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../components/feedback/index.html#api">API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../components/feedback/index.html#implementations">Implementations</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../components/feedback/impl/stm32-halls.html">STM32 Halls</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../components/svpwm/index.html">SV-PWM</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../components/svpwm/index.html#introduction">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../components/svpwm/index.html#api">API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../components/svpwm/index.html#implementations">Implementations</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../components/svpwm/impl/stm32.html">STM32</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../components/svpwm/impl/stm32.html#introduction">Introduction</a></li>
<li class="toctree-l4"><a class="reference internal" href="../components/svpwm/impl/stm32.html#pwm-generation">PWM generation</a></li>
<li class="toctree-l4"><a class="reference internal" href="../components/svpwm/impl/stm32.html#adc-synchronization">ADC synchronization</a></li>
<li class="toctree-l4"><a class="reference internal" href="../components/svpwm/impl/stm32.html#break-function">Break function</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://teslabs.github.io/spinner/doxygen/html/index.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../zbibliography.html">Bibliography</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Spinner</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Current sampling</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/theory/currsmp.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="current-sampling">
<h1>Current sampling<a class="headerlink" href="#current-sampling" title="Link to this heading"></a></h1>
<p>Knowledge of phase currents is at the core of Field Oriented Control as they are
the controlled variables. Multiple methods can be used in order to measure motor
phase currents, being one of the most populars the usage of shunt resistors. We
will also see that current sampling is tightly related to the PWM control
signals and hence the modulation scheme.</p>
<section id="shunt-resistors">
<h2>Shunt resistors<a class="headerlink" href="#shunt-resistors" title="Link to this heading"></a></h2>
<p>It can be demonstrated that current flows through the shunt resistor when the
low transistor is turned on. Therefore, current measurements need to be
synchronized with the PWM switching times.</p>
<p>Only two phase currents are required to know the third one, as in a balanced
system all currents sum zero. If we measure <span class="math notranslate nohighlight">\(i_a\)</span> and <span class="math notranslate nohighlight">\(i_b\)</span>,
<span class="math notranslate nohighlight">\(i_c\)</span> is also known. However, it is not always possible to sample the same
currents as we are limited by the time the low side is active. The detailed
analysis will be limited to the first sector case, for other sectors the same
procedure can be followed.</p>
</section>
<section id="sv-pwm">
<h2>SV-PWM<a class="headerlink" href="#sv-pwm" title="Link to this heading"></a></h2>
<p>When using the SV-PWM modulation technique we have that the duty cycles take a
particular shape that will condition the sampling of the currents. If we look at
the first sector we have that duty cycles look like the animation shown in
<a class="reference internal" href="#currsample-svpwm-anim"><span class="std std-numref">Fig. 1</span></a> (dead-time ignored for simplicity).</p>
<figure class="align-default" id="id1">
<span id="currsample-svpwm-anim"></span><img alt="../_images/currsample-svpwm-anim.gif" src="../_images/currsample-svpwm-anim.gif" />
<figcaption>
<p><span class="caption-number">Fig. 1 </span><span class="caption-text">Duty cycles for the first sector when using SV-PWM.</span><a class="headerlink" href="#id1" title="Link to this image"></a></p>
</figcaption>
</figure>
<p>Actually, other sectors are just a combination of what we have in
<a class="reference internal" href="#currsample-svpwm-anim"><span class="std std-numref">Fig. 1</span></a>, only having direction changes in the linearly
varying phase.</p>
<p>(<a class="reference download internal" download="" href="../_downloads/8f23aed83555a43cc1198424b2515e87/svpwm-modulation.py"><code class="xref download docutils literal notranslate"><span class="pre">Source</span> <span class="pre">code</span></code></a>, <a class="reference download internal" download="" href="../_downloads/6b48e5ae189f244bfd807e2de1f46db9/svpwm-modulation.png"><code class="xref download docutils literal notranslate"><span class="pre">png</span></code></a>, <a class="reference download internal" download="" href="../_downloads/2d388d67d3e10beb21dcf3b5481bbdfa/svpwm-modulation.hires.png"><code class="xref download docutils literal notranslate"><span class="pre">hires.png</span></code></a>, <a class="reference download internal" download="" href="../_downloads/ca549546d39848a0d7936d6397c959d6/svpwm-modulation.pdf"><code class="xref download docutils literal notranslate"><span class="pre">pdf</span></code></a>)</p>
<figure class="align-default" id="id2">
<img alt="../_images/svpwm-modulation.png" class="plot-directive" src="../_images/svpwm-modulation.png" />
<figcaption>
<p><span class="caption-number">Fig. 2 </span><span class="caption-text">SV-PWM duty cycles shape.</span><a class="headerlink" href="#id2" title="Link to this image"></a></p>
</figcaption>
</figure>
<p>Summarizing, we will always have the following situation:</p>
<ol class="arabic simple">
<li><p>A phase with a <strong>high duty cycle</strong>, with its maximum at half of the period.</p></li>
<li><p>A phase that varies <strong>linearly</strong> either <strong>increasing or decreasing</strong> over a
wide range of duty cycles.</p></li>
<li><p>A phase with a <strong>low duty cycle</strong>, with its minimum at half of the period.</p></li>
</ol>
<p>We will use this information in the next section when designing the sampling
strategy.</p>
</section>
<section id="sampling-strategy">
<h2>Sampling strategy<a class="headerlink" href="#sampling-strategy" title="Link to this heading"></a></h2>
<p>Because phase currents flow through the shunt resistor when the low-side is ON
it is clear that we need to synchronize the measurements with the PWM signals.
As we are on a balanced system, we can just measure two phase currents instead
of all three. We also need to consider the modulation scheme (SV-PWM) in order
to understand the limitations we have. As usual we will focus on analyzing the
first SV-PWM sector and extrapolate the results to other sectors.
<a class="reference internal" href="#currsample-mid"><span class="std std-numref">Fig. 4</span></a> provides a timing diagram for the first sector which
will be useful for the analysis.</p>
<figure class="align-default" id="id4">
<span id="currsample-mid"></span><img alt="../_images/currsample-mid.svg" src="../_images/currsample-mid.svg" /><figcaption>
<p><span class="caption-number">Fig. 4 </span><span class="caption-text">Duty cycles and current shapes for sector 1</span><a class="headerlink" href="#id4" title="Link to this image"></a></p>
</figcaption>
</figure>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Variable</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><span class="math notranslate nohighlight">\(\mathrm{T_{RISE}}\)</span></p></td>
<td><p>Time taken by the current signal to rise and
stabilize to its nominal value after a
bottom transistor switch-on event.</p></td>
</tr>
<tr class="row-odd"><td><p><span class="math notranslate nohighlight">\(\mathrm{T_{NOISE}}\)</span></p></td>
<td><p>Time during which electric noise is present
on a phase due to another phase bottom
transistor switch-on event.</p></td>
</tr>
<tr class="row-even"><td><p><span class="math notranslate nohighlight">\(\mathrm{T_{SAMPLE}}\)</span></p></td>
<td><p>Time taken to sample the currents.</p></td>
</tr>
<tr class="row-odd"><td><p><span class="math notranslate nohighlight">\(\mathrm{DT}\)</span></p></td>
<td><p>Dead-Time is a small time added to the PWM
signals so that upper and bottom transistors
do not change state at the same time thus
avoiding shoot-throughs.</p></td>
</tr>
</tbody>
</table>
<p>In order to derive a simple sampling strategy we will assume that sampling is
always started at the middle of the PWM period. When sampling currents we always
need to skip the measurement of the phase that can be potentially OFF in the
active sector. In case of sector one, this happens for phase a, meaning we will
need to sample phases b and c. <a class="reference internal" href="#currsample-svpwm-anim"><span class="std std-numref">Fig. 1</span></a> provides animated
duty cycle waveforms that can help on understanding the given concepts. The same
reasoning can be performed for the other sectors, leading to the results shown
in <a class="reference internal" href="#currsample-phases"><span class="std std-numref">Table 1</span></a>.</p>
<span id="currsample-phases"></span><table class="docutils align-center" id="id5">
<caption><span class="caption-number">Table 1 </span><span class="caption-text">Phases to be sampled on each SV-PWM sector.</span><a class="headerlink" href="#id5" title="Link to this table"></a></caption>
<thead>
<tr class="row-odd"><th class="head"><p>Sector</p></th>
<th class="head"><p>Phases to be sampled</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>1</p></td>
<td><p>b, c</p></td>
</tr>
<tr class="row-odd"><td><p>2</p></td>
<td><p>a, c</p></td>
</tr>
<tr class="row-even"><td><p>3</p></td>
<td><p>a, c</p></td>
</tr>
<tr class="row-odd"><td><p>4</p></td>
<td><p>a, b</p></td>
</tr>
<tr class="row-even"><td><p>5</p></td>
<td><p>a, b</p></td>
</tr>
<tr class="row-odd"><td><p>6</p></td>
<td><p>b, c</p></td>
</tr>
</tbody>
</table>
<p>The only condition we must fulfill is that the time the low side is ON is big
enough to allow sampling the currents. The lowest time the low side is ON is
given by:</p>
<div class="math notranslate nohighlight">
\[\mathrm{t_{min} = T_{PWM} \cdot (1 - d_{max}) - DT}.\]</div>
<p>If we take SV-PWM equations we have that the maximum PWM duty cycle for the
phases to be sampled is:</p>
<div class="math notranslate nohighlight">
\[\mathrm{d_{max}} = \frac{1}{2} + \frac{\sqrt{3}}{4}.\]</div>
<p>As we sample at the middle of the period, we need then:</p>
<div class="math notranslate nohighlight">
\[\mathrm{T_s \leq \frac{t_{min}}{2}}\]</div>
<p>which results in:</p>
<div class="math notranslate nohighlight">
\[\mathrm{T_s \leq \frac{T_{PWM} \cdot \left( \frac{1}{2} - \frac{\sqrt{3}}{4} \right) - DT}{2}}.\]</div>
<p>If this condition is not met, PWM frequency should be reduced.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../index.html" class="btn btn-neutral float-left" title="Spinner Documentation" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="foc.html" class="btn btn-neutral float-right" title="Field Oriented Control" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Teslabs Engineering S.L..</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>